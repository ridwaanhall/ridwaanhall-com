{% extends 'base_seo.html' %}
{% load static %}
{% load socialaccount %}
{% block content %}
<div class="flex-1 md:ml-62">
    <main class="px-3 py-4 sm:px-4 md:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <div class="mb-6 sm:mb-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 sm:gap-6">
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-medium mb-2 tracking-tight">Guest<span class="text-indigo-400">book</span></h1>
                        <p class="mt-1 sm:mt-2 text-base sm:text-lg leading-relaxed">Before you wander off, this corner was made for you to leave a trace after exploring what’s here.</p>
                    </div>
                </div>
            </div>

            {% if messages %}
                <div class="mt-8" id="messages-container">
                    {% for message in messages %}
                        <div class="message-alert mb-4 px-4 py-3 rounded-lg border flex items-center justify-between {% if message.tags == 'success' %}bg-green-900/20 border-green-700 text-green-300{% elif message.tags == 'error' %}bg-red-900/20 border-red-700 text-red-300{% else %}bg-blue-900/20 border-blue-700 text-blue-300{% endif %}">
                            <span>{{ message }}</span>
                            <button type="button" class="close-message-btn cursor-pointer ml-3 p-1 rounded hover:bg-zinc-800 transition-colors" title="Close">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="grid grid-cols-1 gap-6">
                <!-- Guestbook Messages -->
                <div class="border border-zinc-700 rounded-lg shadow-lg flex flex-col">
                    <div class="bg-zinc-800 p-3 rounded-t-lg flex-shrink-0">
                        <h4 class="text-lg font-medium flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                                ></path>
                            </svg>
                            Guestbook Messages
                            <span id="message-count" class="ml-auto bg-white/20 px-2 py-1 rounded-full text-sm">{{ message_count|default:0 }} messages</span>
                        </h4>
                    </div>
                    <!-- Messages Container -->
                    <div id="guestbook-messages" class="overflow-y-auto py-4 space-y-4 flex-1" style="min-height: min(45vh, 600px); max-height: min(55vh, 800px);">
                        {% if chat_messages %}
                            {% for message in chat_messages reversed %}
                            <div class="flex items-start gap-3 px-3" data-message-id="{{ message.pk }}">
                                <!-- User Avatar -->
                                {% if message.user_profile_image %}
                                    <img src="{{ message.user_profile_image }}" alt="{{ message.user_full_name }}" width="40" height="40" class="mt-1 rounded-full border border-zinc-800" />
                                {% else %}
                                    <div class="mt-1 rounded-full border border-zinc-800 w-10 h-10 bg-gradient-to-br from-zinc-500 to-purple-600 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                        </svg>
                                    </div>
                                {% endif %}

                                <!-- Message Content -->
                                <div class="space-y-1 flex-1">
                                    <!-- Reply indicator if this is a reply -->
                                    {% if message.reply_to %}
                                    <div class="flex items-center text-zinc-400 text-xs mb-1">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                        </svg>
                                        {% if message.user == message.reply_to.user %}
                                            <!-- Self-reply: always show "[Author] Replied to self" regardless of current viewer -->
                                            {% if user.is_authenticated and message.user == user %}
                                                <span>You replied to yourself: "{{ message.reply_to.message|truncatechars:30 }}"</span>
                                            {% else %}
                                                <span><span class="font-medium">{{ message.user_full_name }}</span> Replied to self: "{{ message.reply_to.message|truncatechars:30 }}"</span>
                                            {% endif %}
                                        {% elif user.is_authenticated and message.user == user %}
                                            <!-- Current user replied to someone else -->
                                            <span>You replied to <span class="font-medium">{{ message.reply_to.user_full_name }}</span>: "{{ message.reply_to.message|truncatechars:30 }}"</span>
                                        {% elif user.is_authenticated and message.reply_to.user == user %}
                                            <!-- Someone replied to current user -->
                                            <span>Replied to you: "{{ message.reply_to.message|truncatechars:30 }}"</span>
                                        {% else %}
                                            <!-- Someone replied to someone else -->
                                            <span>Replied to <span class="font-medium">{{ message.reply_to.user_full_name }}</span>: "{{ message.reply_to.message|truncatechars:30 }}"</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}

                                    <!-- Header with name and timestamp -->
                                    <div class="flex flex-col items-start gap-3 md:flex-row md:items-center">
                                        <div class="flex items-center gap-2">
                                            <div class="text-sm font-medium">{{ message.user_full_name }}</div>
                                            {% if message.user_is_author %}
                                            <div class="flex items-center gap-0.5 rounded-full bg-gradient-to-bl from-purple-800 via-violet-900 to-purple-800 px-1.5 py-0.5 text-violet-50">
                                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="10" width="10" xmlns="http://www.w3.org/2000/svg">
                                                    <path fill="none" d="M0 0h24v24H0z"></path>
                                                    <path d="M17 11c.34 0 .67.04 1 .09V6.27L10.5 3 3 6.27v4.91c0 4.54 3.2 8.79 7.5 9.82.55-.13 1.08-.32 1.6-.55-.69-.98-1.1-2.17-1.1-3.45 0-3.31 2.69-6 6-6z"></path>
                                                    <path
                                                        d="M17 13c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 1.38c.62 0 1.12.51 1.12 1.12s-.51 1.12-1.12 1.12-1.12-.51-1.12-1.12.5-1.12 1.12-1.12zm0 5.37c-.93 0-1.74-.46-2.24-1.17.05-.72 1.51-1.08 2.24-1.08s2.19.36 2.24 1.08c-.5.71-1.31 1.17-2.24 1.17z"
                                                    ></path>
                                                </svg>
                                                <span class="text-[9px]">Author</span>
                                            </div>
                                            {% elif message.user_is_co_author %}
                                            <div class="flex items-center gap-0.5 rounded-full bg-gradient-to-bl from-amber-700 via-yellow-800 to-amber-700 px-1.5 py-0.5 text-amber-50">
                                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="10" width="10" xmlns="http://www.w3.org/2000/svg">
                                                    <path fill="none" d="M0 0h24v24H0z"></path>
                                                    <path
                                                        d="M16 4l2.29 6.29c.18.18.43.29.71.29s.53-.11.71-.29L22 4H16zM10 4l2.29 6.29c.18.18.43.29.71.29s.53-.11.71-.29L16 4H10zM4 4l2.29 6.29c.18.18.43.29.71.29s.53-.11.71-.29L10 4H4zM7 14c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm10 0c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"
                                                    ></path>
                                                </svg>
                                                <span class="text-[9px]">Co-Author</span>
                                            </div>
                                            {% endif %}
                                            <div class="hidden md:flex">
                                                <div class="text-xs text-zinc-400">{{ message.timestamp|date:"d/m/Y, H:i" }}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Message bubble and actions -->
                                    <div class="group flex items-center gap-3">
                                        <p
                                            class="w-fit rounded-lg rounded-tl-none bg-zinc-800 px-3 py-2 group-hover:bg-zinc-700 transition-colors"
                                            data-message-id="{{ message.pk }}"
                                            data-user="{{ message.user_full_name }}"
                                            data-message="{{ message.message|escape }}"
                                        >
                                            {{ message.message|escape|linebreaksbr }}
                                        </p>
                                        <!-- Action buttons - Always show reply button, delete only for authors -->
                                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button
                                                class="{% if user.is_authenticated %}reply-btn{% else %}login-required-btn{% endif %} p-1.5 rounded-lg hover:bg-zinc-600 transition-colors"
                                                data-message-id="{{ message.pk }}"
                                                data-user="{{ message.user_full_name }}"
                                                data-message="{{ message.message|escape }}"
                                                title="{% if user.is_authenticated %}Reply to this message{% else %}Sign in to reply{% endif %}"
                                            >
                                                <svg class="w-4 h-4 text-zinc-400 hover:text-zinc-200 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                                </svg>
                                            </button>
                                            {% if user.is_authenticated and current_user_profile.is_author %}
                                            <button class="delete-btn p-1.5 rounded-lg hover:bg-red-900/30 transition-colors" data-message-id="{{ message.pk }}" title="Delete this message">
                                                <svg class="w-4 h-4 text-zinc-400 hover:text-red-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                    ></path>
                                                </svg>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Mobile timestamp -->
                                    <div class="flex md:hidden">
                                        <div class="text-xs text-zinc-400">{{ message.timestamp|date:"d/m/Y, H:i" }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center text-zinc-400 py-16">
                            <svg class="w-16 h-16 mx-auto mb-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                                ></path>
                            </svg>
                            <h5 class="text-lg font-medium mb-2">Welcome to my Guestbook!</h5>
                            <p class="mb-4">No messages yet. Be the first to leave a message!</p>
                            {% if not user.is_authenticated %}
                            <div class="flex flex-col sm:flex-row gap-2 justify-center">
                                <a href="{% provider_login_url 'google' %}" class="inline-flex items-center px-4 py-2 bg-zinc-600 hover:bg-zinc-700 rounded-lg transition-colors duration-200">
                                    <svg
                                        stroke="currentColor"
                                        fill="currentColor"
                                        stroke-width="0"
                                        version="1.1"
                                        x="0px"
                                        y="0px"
                                        viewBox="0 0 48 48"
                                        enable-background="new 0 0 48 48"
                                        height="18"
                                        width="18"
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="mr-2"
                                    >
                                        <path
                                            fill="#FFC107"
                                            d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12 c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24 c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
                                        ></path>
                                        <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657 C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                                        <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36 c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
                                        <path
                                            fill="#1976D2"
                                            d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571 c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
                                        ></path>
                                    </svg>
                                    Sign in with Google
                                </a>
                                <a href="{% provider_login_url 'github' %}" class="inline-flex items-center px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors duration-200">
                                    <svg height="18" width="18" viewBox="0 0 16 16" version="1.1" aria-hidden="true" fill="currentColor" class="mr-2">
                                        <path
                                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
                                        ></path>
                                    </svg>
                                    Sign in with GitHub
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Message Input -->
                    <div class="border-t border-zinc-700 p-3 flex-shrink-0">
                        {% if user.is_authenticated %}
                        <!-- Reply indicator -->
                        <div id="reply-indicator" class="hidden mb-3">
                            <div class="border border-zinc-500 rounded-lg p-3 flex justify-between items-center">
                                <div class="flex items-center text-zinc-400 text-sm">
                                    <svg class="w-4 h-4 mr-2 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                    </svg>
                                    <span class="text-zinc-500">Replying to</span>
                                    <strong id="reply-to-user" class="text-zinc-300 mx-1"></strong>
                                    <span class="text-zinc-500">:</span>
                                    <span id="reply-to-message" class="ml-1 truncate max-w-32 sm:max-w-48"></span>
                                </div>
                                <button type="button" id="cancel-reply" class="p-1 rounded border border-transparent hover:border-zinc-600/50 transition-colors">
                                    <svg class="w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <form id="guestbook-form" class="flex gap-3">
                            {% csrf_token %}
                            <input type="hidden" id="reply-to-id" name="reply_to" value="" />
                            <input
                                type="text"
                                id="message-input"
                                class="flex-1 px-4 py-3 border border-zinc-600 rounded-lg placeholder-zinc-400 focus:outline-none focus:border-zinc-500 focus:ring-1 focus:ring-zinc-500 bg-transparent"
                                placeholder="Type your message..."
                                maxlength="500"
                                required
                            />
                            <button type="submit" class="w-12 h-12 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors duration-200 flex items-center justify-center">
                                <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="22" width="22" xmlns="http://www.w3.org/2000/svg">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </form>
                        {% if user.is_authenticated %}
                        <div class="mt-3 text-sm text-zinc-400">
                            <span>Signed in as {{ current_user_profile.full_name|default:user.username }}{% if current_user_profile.email %} ({{ current_user_profile.email }}){% endif %} • </span>
                            <form method="post" action="{% url 'account_logout' %}" class="inline">
                                {% csrf_token %}
                                <button type="submit" class="text-zinc-400 hover:text-zinc-300 cursor-pointer underline transition-colors">
                                    Sign Out
                                </button>
                            </form>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="text-center py-4">
                            <span class="text-zinc-400 mb-4 flex items-center justify-center">
                                <span>
                                    Sign in to begin. Rest assured, your information is secure.
                                    See my
                                    <a href="{% url 'privacy' %}" class="text-indigo-400 hover:text-indigo-300 underline">privacy</a>
                                    for more.
                                </span>
                            </span>
                            <div class="flex flex-row gap-2 justify-center">
                                <a href="{% provider_login_url 'google' %}" class="inline-flex items-center px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-md transition-colors duration-200 text-sm gap-1 justify-center">
                                    <svg
                                        stroke="currentColor"
                                        fill="currentColor"
                                        stroke-width="0"
                                        version="1.1"
                                        x="0px"
                                        y="0px"
                                        viewBox="0 0 48 48"
                                        enable-background="new 0 0 48 48"
                                        height="18"
                                        width="18"
                                        xmlns="http://www.w3.org/2000/svg"
                                    >
                                        <path
                                            fill="#FFC107"
                                            d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12 c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24 c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
                                        ></path>
                                        <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657 C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                                        <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36 c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
                                        <path
                                            fill="#1976D2"
                                            d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571 c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
                                        ></path>
                                    </svg>
                                    Sign in with Google
                                </a>
                                <a href="{% provider_login_url 'github' %}" class="inline-flex items-center px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-md transition-colors duration-200 text-sm gap-1 justify-center">
                                    <svg height="18" width="18" viewBox="0 0 16 16" version="1.1" aria-hidden="true" fill="currentColor">
                                        <path
                                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
                                        ></path>
                                    </svg>
                                    Sign in with GitHub
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}
{% block scripts %}
<script>
    // HTML escaping function to prevent XSS
    function escapeHtml(text) {
        if (typeof text !== "string") return text;
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Message alerts functionality
        function removeMessage(messageElement) {
            if (messageElement) {
                messageElement.style.transition = "all 0.3s ease";
                messageElement.style.opacity = "0";
                messageElement.style.transform = "translateY(-10px)";
                setTimeout(() => {
                    messageElement.remove();
                    
                    // Remove the entire messages container if no messages left
                    const messagesContainer = document.getElementById("messages-container");
                    if (messagesContainer && messagesContainer.children.length === 0) {
                        messagesContainer.remove();
                    }
                }, 300);
            }
        }

        // Handle close button clicks
        document.addEventListener("click", function (e) {
            if (e.target.closest(".close-message-btn")) {
                const messageElement = e.target.closest(".message-alert");
                removeMessage(messageElement);
            }
        });

        // Auto-remove messages after 6 seconds
        const messageAlerts = document.querySelectorAll(".message-alert");
        messageAlerts.forEach((messageElement) => {
            setTimeout(() => {
                removeMessage(messageElement);
            }, 6000); // 6 seconds
        });

        // Update current time
        function updateTime() {
            const now = new Date();
            const jakartaTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Jakarta" }));
            const timeString = jakartaTime.toLocaleString("en-US", {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: true,
            });
            const timeElement = document.getElementById("current-time");
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // Update time immediately and then every second
        updateTime();
        setInterval(updateTime, 1000);

        // Guestbook functionality
        const guestbookForm = document.getElementById("guestbook-form");
        const messageInput = document.getElementById("message-input");
        const guestbookMessages = document.getElementById("guestbook-messages");

        // Auto-scroll to bottom of messages
        function scrollToBottom() {
            if (guestbookMessages) {
                guestbookMessages.scrollTop = guestbookMessages.scrollHeight;
            }
        }

        // Initial scroll to bottom
        scrollToBottom();

        // Handle form submission
        if (guestbookForm) {
            guestbookForm.addEventListener("submit", function (e) {
                e.preventDefault();

                const message = messageInput.value.trim();
                if (!message) return;

                // Disable form while sending
                messageInput.disabled = true;
                const submitBtn = guestbookForm.querySelector('button[type="submit"]');
                const originalBtnContent = submitBtn.innerHTML;
                submitBtn.innerHTML =
                    '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';

                // Send message via AJAX
                fetch('{% url "send_message" %}', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                    },
                    body: new URLSearchParams({
                        message: message,
                        reply_to: document.getElementById("reply-to-id").value,
                    }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            // Create user name with author/co-author badge if applicable
                            const authorBadgeHtml = data.message.is_author
                                ? `<div class="flex items-center gap-0.5 rounded-full bg-gradient-to-bl from-purple-800 via-violet-900 to-purple-800 px-1.5 py-0.5 text-violet-50">
                                        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="10" width="10" xmlns="http://www.w3.org/2000/svg">
                                            <path fill="none" d="M0 0h24v24H0z"></path>
                                            <path d="M17 11c.34 0 .67.04 1 .09V6.27L10.5 3 3 6.27v4.91c0 4.54 3.2 8.79 7.5 9.82.55-.13 1.08-.32 1.6-.55-.69-.98-1.1-2.17-1.1-3.45 0-3.31 2.69-6 6-6z"></path>
                                            <path d="M17 13c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 1.38c.62 0 1.12.51 1.12 1.12s-.51 1.12-1.12 1.12-1.12-.51-1.12-1.12.5-1.12 1.12-1.12zm0 5.37c-.93 0-1.74-.46-2.24-1.17.05-.72 1.51-1.08 2.24-1.08s2.19.36 2.24 1.08c-.5.71-1.31 1.17-2.24 1.17z"></path>
                                        </svg>
                                        <span class="text-[9px]">Author</span>
                                    </div>`
                                : data.message.is_co_author
                                ? `<div class="flex items-center gap-0.5 rounded-full bg-gradient-to-bl from-amber-700 via-yellow-800 to-amber-700 px-1.5 py-0.5 text-amber-50">
                                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="10" width="10" xmlns="http://www.w3.org/2000/svg">
                                                <path fill="none" d="M0 0h24v24H0z"></path>
                                                <path d="M16 4l2.29 6.29c.18.18.43.29.71.29s.53-.11.71-.29L22 4H16zM10 4l2.29 6.29c.18.18.43.29.71.29s.53-.11.71-.29L16 4H10zM4 4l2.29 6.29c.18.18.43.29.71.29s.53-.11.71-.29L10 4H4zM7 14c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm10 0c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path>
                                            </svg>
                                            <span class="text-[9px]">Co-Author</span>
                                        </div>`
                                : "";

                            // Create profile image or default avatar
                            const avatarHtml = data.message.profile_image
                                ? `<img src="${escapeHtml(data.message.profile_image)}" alt="${escapeHtml(data.message.user)}" width="40" height="40" class="mt-1 rounded-full border border-zinc-800">`
                                : `<div class="mt-1 rounded-full border border-zinc-800 w-10 h-10 bg-gradient-to-br from-zinc-500 to-purple-600 flex items-center justify-center">
                                     <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                         <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                     </svg>
                                   </div>`;

                            // Create reply indicator if this is a reply
                            let replyHtml = "";
                            if (data.message.reply_to) {
                                // Check if replying to self by comparing user IDs
                                const isReplyToSelf = data.message.user_id === data.message.reply_to.user_id;
                                const currentUserId = {% if user.is_authenticated %}{{ user.id }}{% else %}null{% endif %};
                                
                                if (isReplyToSelf) {
                                    // Self-reply: check if current user is the author
                                    if (currentUserId === data.message.user_id) {
                                        replyHtml = `
                                            <div class="flex items-center text-zinc-400 text-xs mb-1">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                                </svg>
                                                <span>You replied to yourself: "${escapeHtml(data.message.reply_to.message)}"</span>
                                            </div>
                                        `;
                                    } else {
                                        replyHtml = `
                                            <div class="flex items-center text-zinc-400 text-xs mb-1">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                                </svg>
                                                <span><span class="font-medium">${escapeHtml(data.message.user)}</span> Replied to self: "${escapeHtml(data.message.reply_to.message)}"</span>
                                            </div>
                                        `;
                                    }
                                } else if (currentUserId === data.message.user_id) {
                                    // Current user replied to someone else
                                    replyHtml = `
                                        <div class="flex items-center text-zinc-400 text-xs mb-1">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                            </svg>
                                            <span>You replied to <span class="font-medium">${escapeHtml(data.message.reply_to.user)}</span>: "${escapeHtml(data.message.reply_to.message)}"</span>
                                        </div>
                                    `;
                                } else if (currentUserId === data.message.reply_to.user_id) {
                                    // Someone replied to current user
                                    replyHtml = `
                                        <div class="flex items-center text-zinc-400 text-xs mb-1">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                            </svg>
                                            <span>Replied to you: "${escapeHtml(data.message.reply_to.message)}"</span>
                                        </div>
                                    `;
                                } else {
                                    // Someone replied to someone else
                                    replyHtml = `
                                        <div class="flex items-center text-zinc-400 text-xs mb-1">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                            </svg>
                                            <span>Replied to <span class="font-medium">${escapeHtml(data.message.reply_to.user)}</span>: "${escapeHtml(data.message.reply_to.message)}"</span>
                                        </div>
                                    `;
                                }
                            }

                            // Use timestamp directly from server (already in Jakarta time)
                            // The server already returns the correct Jakarta time format
                            const jakartaTime = data.message.timestamp;

                            // Add message to guestbook
                            const messageHtml = `
                                <div class="flex items-start gap-3 px-3" data-message-id="${data.message.id}">
                                    ${avatarHtml}
                                    <div class="space-y-1 flex-1">
                                        ${replyHtml}
                                        <div class="flex flex-col items-start gap-3 md:flex-row md:items-center">
                                            <div class="flex items-center gap-2">
                                                <div class="text-sm font-medium">${escapeHtml(data.message.user)}</div>
                                                ${authorBadgeHtml}
                                                <div class="hidden md:flex">
                                                    <div class="text-xs text-zinc-400">${jakartaTime}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="group flex items-center gap-3">
                                            <p class="w-fit rounded-lg rounded-tl-none bg-zinc-800 px-3 py-2 group-hover:bg-zinc-700 transition-colors"
                                               data-message-id="${data.message.id}"
                                               data-user="${escapeHtml(data.message.user)}"
                                               data-message="${escapeHtml(data.message.message)}"></p>
                                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button class="reply-btn p-1.5 rounded-lg hover:bg-zinc-600 transition-colors"
                                                        data-message-id="${data.message.id}"
                                                        data-user="${escapeHtml(data.message.user)}"
                                                        data-message="${escapeHtml(data.message.message)}"
                                                        title="Reply to this message">
                                                    <svg class="w-4 h-4 text-zinc-400 hover:text-zinc-200 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                                    </svg>
                                                </button>
                                                {% if current_user_profile.is_author %}
                                                <button class="delete-btn p-1.5 rounded-lg hover:bg-red-900/30 transition-colors"
                                                        data-message-id="${data.message.id}"
                                                        title="Delete this message">
                                                    <svg class="w-4 h-4 text-zinc-400 hover:text-red-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                    </svg>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="flex md:hidden">
                                            <div class="text-xs text-zinc-400">${jakartaTime}</div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            // Remove "no messages" placeholder if it exists
                            const noMessages = guestbookMessages.querySelector(".text-center.text-zinc-400.py-16");
                            if (noMessages) {
                                noMessages.remove();
                            }

                            guestbookMessages.insertAdjacentHTML("beforeend", messageHtml);

                            // Safely set the message content as text to prevent XSS
                            const messageContainer = guestbookMessages.lastElementChild;
                            const messageParagraph = messageContainer.querySelector("p");
                            if (messageParagraph) {
                                messageParagraph.textContent = data.message.message;
                                // Convert line breaks to HTML for display safely
                                const lines = messageParagraph.textContent.split("\n");
                                messageParagraph.textContent = ""; // Clear existing content
                                lines.forEach((line, index) => {
                                    if (index > 0) {
                                        messageParagraph.appendChild(document.createElement("br"));
                                    }
                                    messageParagraph.appendChild(document.createTextNode(line));
                                });
                            }

                            messageInput.value = "";
                            scrollToBottom();

                            // Clear reply state
                            clearReply();

                            // Update message count
                            const messageCountBadge = document.getElementById("message-count");
                            if (messageCountBadge) {
                                const currentCount = parseInt(messageCountBadge.textContent.split(" ")[0]) || 0;
                                messageCountBadge.textContent = `${currentCount + 1} messages`;
                            }
                        } else {
                            alert("Error: " + data.error);
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        alert("Failed to send message. Please try again.");
                    })
                    .finally(() => {
                        // Re-enable form
                        messageInput.disabled = false;
                        submitBtn.innerHTML = originalBtnContent;
                        messageInput.focus();
                    });
            });

            // Handle Enter key
            messageInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    guestbookForm.dispatchEvent(new Event("submit"));
                }
            });
        } // Reply functionality
        function setReply(messageId, userName, messageText) {
            const replyIndicator = document.getElementById("reply-indicator");
            const replyToUser = document.getElementById("reply-to-user");
            const replyToMessage = document.getElementById("reply-to-message");
            const replyToId = document.getElementById("reply-to-id");
            const messageInput = document.getElementById("message-input");

            if (replyToUser) replyToUser.textContent = userName;
            if (replyToMessage) replyToMessage.textContent = messageText;
            if (replyToId) replyToId.value = messageId;
            if (replyIndicator) replyIndicator.classList.remove("hidden");
            if (messageInput) {
                messageInput.focus();
                messageInput.placeholder = `Reply to ${userName}...`;
            }
        }

        function clearReply() {
            const replyIndicator = document.getElementById("reply-indicator");
            const replyToId = document.getElementById("reply-to-id");
            const messageInput = document.getElementById("message-input");

            if (replyIndicator) replyIndicator.classList.add("hidden");
            if (replyToId) replyToId.value = "";
            if (messageInput) messageInput.placeholder = "Type your message...";
        }

        // Function to show login required message
        function showLoginMessage(userName) {
            // Create and show a temporary message
            const messagesContainer = document.getElementById("messages-container") || document.querySelector(".max-w-7xl");
            
            // Create message element
            const messageElement = document.createElement("div");
            messageElement.className = "message-alert mb-4 px-4 py-3 rounded-lg border flex items-center justify-between bg-blue-900/20 border-blue-700 text-blue-300";
            messageElement.innerHTML = `
                <span>You must <a href="{% provider_login_url 'google' %}" class="text-blue-200 hover:text-blue-100 underline">sign in</a> to reply to ${escapeHtml(userName)}'s message.</span>
                <button type="button" class="close-message-btn cursor-pointer ml-3 p-1 rounded hover:bg-zinc-800 transition-colors" title="Close">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            
            // Insert at the top of the page
            const mainContent = document.querySelector(".max-w-7xl");
            if (mainContent) {
                const firstChild = mainContent.children[1] || mainContent.firstElementChild; // After the header
                mainContent.insertBefore(messageElement, firstChild);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    removeMessage(messageElement);
                }, 5000);
            }
        } // Handle reply button clicks
        document.addEventListener("click", function (e) {
            if (e.target.closest(".reply-btn")) {
                const button = e.target.closest(".reply-btn");
                const messageId = button.dataset.messageId;
                const userName = button.dataset.user;
                const messageText = button.dataset.message;
                setReply(messageId, userName, messageText);
            }
        });

        // Handle login-required button clicks
        document.addEventListener("click", function (e) {
            if (e.target.closest(".login-required-btn")) {
                const button = e.target.closest(".login-required-btn");
                const userName = button.dataset.user;
                showLoginMessage(userName);
            }
        });

        // Handle delete button clicks
        document.addEventListener("click", function (e) {
            if (e.target.closest(".delete-btn")) {
                const button = e.target.closest(".delete-btn");
                const messageId = button.dataset.messageId;

                if (confirm("Are you sure you want to delete this message?")) {
                    // Disable button while deleting
                    button.disabled = true;
                    const originalContent = button.innerHTML;
                    button.innerHTML =
                        '<svg class="w-4 h-4 animate-spin text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';

                    // Send delete request
                    fetch('{% url "delete_message" %}', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                        },
                        body: new URLSearchParams({
                            message_id: messageId,
                        }),
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            // Remove the message from the DOM - find the parent message container
                            const messageElement = button.closest("[data-message-id]");
                            if (messageElement) {
                                messageElement.style.transition = "all 0.3s ease";
                                messageElement.style.opacity = "0";
                                messageElement.style.transform = "translateX(-100%)";
                                setTimeout(() => {
                                    messageElement.remove();

                                    // Update message count
                                    const messageCountBadge = document.getElementById("message-count");
                                    if (messageCountBadge) {
                                        const currentCount = parseInt(messageCountBadge.textContent.split(" ")[0]) || 0;
                                        const newCount = Math.max(0, currentCount - 1);
                                        messageCountBadge.textContent = `${newCount} messages`;
                                    }
                                }, 300);
                            }
                        } else {
                            alert("Error: " + (data.error || "Failed to delete message"));
                            // Restore button
                            button.disabled = false;
                            button.innerHTML = originalContent;
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        alert("Failed to delete message. Please try again.");
                        // Restore button
                        button.disabled = false;
                        button.innerHTML = originalContent;
                    });
                }
            }
        });

        // Handle cancel reply button
        const cancelReplyBtn = document.getElementById("cancel-reply");
        if (cancelReplyBtn) {
            cancelReplyBtn.addEventListener("click", clearReply);
        }
    });
</script>

{% endblock %}
